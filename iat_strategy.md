# 免短策略总结

本文档总结了系统在**注册**和**登录**场景下实现“免短信验证”（免短）的核心策略，涵盖多维度设备、身份与行为信息的校验逻辑。

---

## 一、注册免短策略

在用户注册时，若满足以下任一验证条件并通过，可免短信验证。同时，系统会记录相关信息用于后续注册校验。

### 1. IAT 验证
- 验证通过后，保存当前连接的 `iat` 信息。
- 下次注册时，校验 `iat` 信息是否匹配。

### 2. 邮箱验证
- 删除账号时，记录该账号曾注册的**邮箱信息**。
- 下次注册时，校验新注册号码是否关联过该邮箱。

### 3. SIM 卡验证
- 删除账号时，记录该账号绑定的 **SIM 卡电话号码**。
- 下次注册时，校验新注册号码是否使用过该 SIM 卡。

### 4. antiUdid 验证
- 验证通过后，保存 `antiUdid` 信息。
- 下次注册时，仅当使用**同一设备**（相同 `antiUdid`）才可免验。
- ⚠️ 若账号已在设备 B 通过验证，则设备 A 再次注册**不能免验**。

### 5. 注册设备验证
- 注册时保存设备信息。
- 下次注册时，校验是否为**同一注册设备**。

### 6. antiSdkId 验证
- 验证通过后，保存 `antiSdkId`。
- 下次注册时，仅当使用**同一设备**（相同 `antiSdkId`）才可免验。
- ⚠️ 若账号已在设备 B 通过验证，则设备 A 再次注册**不能免验**。

### 7. 上次账号注册设备验证
- 删除账号时，记录其注册时的 `antiUdid` 信息。
- 下次注册时，校验新注册号码是否关联过该 `antiUdid`。

### 8. 上次账号信任设备验证
- 删除账号时，记录其**信任设备信息**。
- 下次注册时，校验新注册设备是否在信任列表中。

---

## 二、登录免短策略

在用户登录时，若满足以下验证条件，可免短信验证。

### 通用策略（适用于 iOS & Android）
- **IAT 验证**：验证通过后保存 `iat` 信息，下次登录时校验。

---

### iOS 免短策略

#### 1. IAT 验证
- 验证通过后保存 `iat` 信息，下次登录校验。

#### 2. iCloud IAT 验证
- 将 `iat` 信息同步至 iCloud。
- 下次登录时，可通过 iCloud 校验 `iat` 的 `uid` 信息。

#### 3. Keychain IAT 验证
- 将 `iat` 信息存储于设备 Keychain。
- 下次登录时，从 Keychain 读取并校验 `iat` 的 `uid` 信息。

#### 4. antiSdkId 验证
- 验证通过后保存 `antiSdkId`。
- 仅当使用**同一设备**注册/登录时可免验。
- ⚠️ 设备切换后，原设备免验失效。

---

### Android 免短策略

#### 1. IAT 验证
- 验证通过后保存 `iat` 信息，下次登录校验。

#### 2. antiUdid 验证
- 验证通过后保存 `antiUdid`。
- 仅当使用**同一设备**可免验。
- ⚠️ 设备切换后，原设备免验失效。

#### 3. antiSdkId 验证
- 验证通过后保存 `antiSdkId`。
- 仅当使用**同一设备**可免验。
- ⚠️ 设备切换后，原设备免验失效。

#### 4. 相同 SIM 卡验证
- 若账号绑定的 SIM 卡 与 `get_started` 时的 SIM 卡一致，可免验。

#### 5. 相同 Email 验证
- 若账号绑定的 Email 与 `get_started` 时的 Email 一致，可免验。

#### 6. SIM 卡列表验证
- 若 `get_started` 时的 SIM 卡 **存在于账号历史 SIM 卡列表中**，可免验。

#### 7. Email 列表验证
- 若 `get_started` 时的 Email **存在于账号历史 Email 列表中**，可免验。

#### 8. Email 设备指纹验证
- 若 `get_started` 时的 Email 对应的**设备指纹**与当前设备一致，可免验。

#### 9. ADID 验证（Android Advertising ID）
- 若当前设备的 Google ADID 与账号历史保存的 ADID 一致，可免验。

---

> **说明**：
> - **antiUdid / antiSdkId**：设备唯一性标识（防篡改）。
> - **IAT**：Identity Authentication Token，身份认证令牌。
> - **get_started**：指用户首次启动 App 并初始化设备信息的阶段。
> - 所有“设备切换后免验失效”策略，旨在防止账号在非信任设备上滥用免短功能。